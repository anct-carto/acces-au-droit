<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Accès Au Droit</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
	<link rel="stylesheet" href="leaflet-search.css" />
	<link rel="stylesheet" href="https://rawgit.com/lokesh-coder/pretty-checkbox/master/dist/pretty-checkbox.css" />
    <style>

body {
    margin: 0;
    padding: 0;
}

#mapid {
     position: absolute;
     top: 0;
     bottom: 0;
     width: 100%;
	 height: 100%;
}

.global {
	background-color:white;
}

#bloc1 {float:left; }
#bloc2 {float:left; }
#bloc3 {float:left; }

h3 {
	color: #3e505b;
	font-weight:bold;
	text-decoration: underline;
	font-size:1em;
	text-transform: uppercase;
}

.btn-group-sm {
	background-color:white;
	border-radius:7px;
	-moz-border-radius:7px;
	-webkit-border-radius:7px;
	box-shadow: 0 1px 5px rgba(0,0,0,0.65);
}

.bloc {
	padding:10px;	
	margin:0px;
	
}
	
.ol-popup {
	background-color:white;
	min-width:220px;
	max-width:350px;
	font-family: Trebuchet MS, verdana, sans serif; 
}
 .ol-popup h1,.ol-popup .h1 {
	margin:-20px;
	color:#fff;
	font-weight:bold;
	padding:15px;
	font-size:1.1em;
	border-radius:6px 6px 0 0;
	-moz-border-radius:6px 6px 0 0;
	-webkit-border-radius:6px 6px 0 0
}
.ol-popup h2 ,.ol-popup .h2{
	font-weight:bold;
	font-size:1em;
	text-decoration: underline;
}
.ol-popup p {
	margin:10px 0;
	font-size:1em;
	line-height:1em
}
.ol-popup .email:before {
	content:"";
	background: url(picto_couriel.png) no-repeat;
	display:inline-block;
	width:10px;
	height:10px;
	background-size:contain;
	margin-right:5px
}
.ol-popup .tel:before {
	content:"";
	background:url(picto_telephone.png) no-repeat;
	display:inline-block;
	width:10px;
	height:10px;
	background-size:contain;
	margin-right:5px
}

.leaflet-control-search .france-button {
	display:block;
	float:left;
	width:54px;
	height:54px;	
	background: url('France_off.png') no-repeat 2px 2px #fff;
	border-radius:4px;
}
.leaflet-control-search .france-button:hover {
	background: url('France_on.png') no-repeat 2px 2px #fafafa;
}


    </style>
</head>

<body>

	<div id="mapid" style=""></div>
	
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
	<script src="leaflet-search.js"></script>
	<script src="https://rawgit.com/yigityuce/Leaflet.Control.Custom/master/Leaflet.Control.Custom.js"></script>
	<script type="text/javascript" src="regions.js"></script>
	<script type="text/javascript" src="departements.js"></script>
	<script type="text/javascript" src="associations.js"></script>

	<script type="text/javascript" src="drom.js"></script>
	<script type="text/javascript" src="cercles_drom.js"></script>
	
    <script>
		
		function test() {alert('coucou')};
		// Initialisation des variables pour le filtre attributaire
		var accompagne = "oui"; 
		var violence = "oui"; 
		var psy = "oui";
		var social = "oui";
		var generaliste = "oui";
		
		//Couleur par défaut des popup
		var title_color = "727272";
		
		//Définition et ajout des picto
		var LeafIcon = L.Icon.extend({
		options: {
			//shadowUrl: 'shadow.png',
			//shadowSize:   [23, 45],
			//shadowAnchor: [0, 0],
			iconSize:     [27, 30],
			iconAnchor:   [0, 0],
			popupAnchor:  [13, 0]
		}
		});
		
		var orangeIcon = new LeafIcon({iconUrl: 'PICTOS-01.png'}),
			vertIcon = new LeafIcon({iconUrl: 'PICTOS-02.png'}),
			violetIcon = new LeafIcon({iconUrl: 'PICTOS-03.png'}),
			roseFonceIcon = new LeafIcon({iconUrl: 'PICTOS-04.png'}),
			bleuIcon = new LeafIcon({iconUrl: 'PICTOS-05.png'});
			rougeIcon = new LeafIcon({iconUrl: 'PICTOS-06.png'});
			jauneIcon = new LeafIcon({iconUrl: 'PICTOS-08.png'}),
			vertFonceIcon = new LeafIcon({iconUrl: 'PICTOS-09.png'}),
			roseIcon = new LeafIcon({iconUrl: 'PICTOS-10.png'}),
			marronIcon = new LeafIcon({iconUrl: 'PICTOS-11.png'}),
			bleuFonceIcon = new LeafIcon({iconUrl: 'PICTOS-12.png'});
			bordeauxIcon = new LeafIcon({iconUrl: 'PICTOS-13.png'});
		
		// Attribution d'une couleur par fédération
		function colorIcon(fede) {
			if (fede === "01") return orangeIcon;
			if (fede === "02") return vertIcon;
			if (fede === "03") return violetIcon;
			if (fede === "04") return roseFonceIcon;
			if (fede === "05") return bleuIcon;
			if (fede === "06") return rougeIcon;
			if (fede === "07") return jauneIcon;
			if (fede === "08") return vertFonceIcon;
			if (fede === "09") return roseIcon;
			if (fede === "10") return marronIcon;
			if (fede === "11") return bleuFonceIcon;
			if (fede === "13") return bordeauxIcon;
			else return bleuIcon;
		}
			
		// Création de la carte
		var map = L.map('mapid')
			.setView([48, 2.2], 6);
		map.zoomControl.setPosition('topright');
		
		
		/*Ajout du fond de carte ign : TUTO https://geoservices.ign.fr/documentation/utilisation_web/wmts-leaflet.html
		L.tileLayer("https://wxs.ign.fr/ujorz7d7mcjaj467ejaqcj6l/geoportail/wmts?service=WMTS&request=GetTile&version=1.0.0&tilematrixset=PM&tilematrix={z}&tilecol={x}&tilerow={y}&layer=ORTHOIMAGERY.ORTHOPHOTOS&format=image/jpeg&style=normal",
			{
				minZoom:0,
				maxZoom:18,
				tileSize:256
			}
		).addTo(map) ;*/

		// Choix du fond de carte
		var basemap = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
		   attribution: '©OpenStreetMap, ©CartoDB, CGET service Carto',
		   subdomains: 'abcd',
		   maxZoom: 19
		   }).addTo(map);
		
		// Création des popup
		function onEachFeature(feature, layer) {
		if(feature.properties.ID_FEDE=="01"){title_color="f0900f"} else if (feature.properties.ID_FEDE=="02"){title_color="99c11f"} else if (feature.properties.ID_FEDE=="03"){title_color="9d88be"} else if (feature.properties.ID_FEDE=="04"){title_color="dd4e8a"} else if (feature.properties.ID_FEDE=="05"){title_color="2dbbeb"} else if (feature.properties.ID_FEDE=="06"){title_color="f04600"}else if (feature.properties.ID_FEDE=="07"){title_color="ffdc00"} else if (feature.properties.ID_FEDE=="08"){title_color="3ca936"}else if (feature.properties.ID_FEDE=="09"){title_color="f29fc3"} else if (feature.properties.ID_FEDE=="10"){title_color="bc8000"}else if (feature.properties.ID_FEDE=="11"){title_color="0069b2"} else if (feature.properties.ID_FEDE=="13"){title_color="881002"};
		var popupcontent = "<div id='popup' class='ol-popup'><h1 style='background-color: #"+title_color+"'>" + feature.properties.NOM_PERM + " (" +feature.properties.NOM_ASSO + ")</h1><h2></br>Coordonnées</h2><p class='email'>" + feature.properties.NOM_LIEU + ", " + feature.properties.ADRESSE + ", " + feature.properties.COMMUNE + "</p><p class='tel'>" + feature.properties.TEL_PERM + " / " + feature.properties.TEL_NAT + "</p><p>" + feature.properties.HORAIRE + "</p><p>" + feature.properties.INTERNET + "</p><h2 style='color: #"+title_color+"'>Spécialisé dans : </h2><p>Droit des étrangers, droits sociaux, violences à caractère raciste, violences à caractère sexiste, lutte contres les discriminations</p><h2 style='color: #"+title_color+"'>Accompagnement proposé au public : </h2><p>Accompagnement social, juridique, psychologique, médical</p><h2 style='color: #"+title_color+"'>Public pris en charge : </h2><p>Spécifique personnes âgées, femme / tout public</p><p  style='color: #727272; font-style: italic'>" + feature.properties.COM + "</p></div>";
		layer.bindPopup(popupcontent);
		}
		
		// Ajout des couches
		var REGIONS = new L.geoJSON(reg, {"color": "#ffffff", "weight": 1, "opacity": 0, fillOpacity: 0});
		var DEPARTEMENTS = new L.geoJSON(dep, {"color": "#ffffff", "weight": 1, "opacity": 0, fillOpacity: 0});
		var Assos = new L.geoJSON;
		
		function AjouterAssos(accompagne, violence, psy, social, generaliste) {
		Assos = L.geoJSON(Associations, {
				pointToLayer: function(feature, latlng) {
				return L.marker(latlng, {
				icon: colorIcon(feature.properties.ID_FEDE)
				});
				},
				filter: function (feature) {
				return (feature.properties.ACCOMPAGNE == accompagne && feature.properties.VIOLENCES2 == violence && feature.properties.ECOUTE_PSY == psy && feature.properties.DROITS_SOC == social && feature.properties.GENERALIST == generaliste) ;
				},
				onEachFeature: onEachFeature
		}).addTo(map);	
		;
		}	
		
		AjouterAssos(accompagne, violence, psy, social, generaliste) ;
		
		
		
		//Ajout du filtre des associations
		L.control.custom({
                position: 'topleft',
				content : 
						'<div class="global">'+
						  '<div class="bloc" id="bloc1"><h3>Association spécialisée dans</h3>'+
                          '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Droit des étrangers</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Droits sociaux</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="ACCOMPAGNE" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Violences à caractère raciste</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Violences à caractère sexiste</label></div></div>'+
						  '</div>'+
						  
						  '<div class="bloc" id="bloc2"><h3>Accompagnement proposé au public</h3>'+
                          '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement social</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement juridique</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="ACCOMPAGNE" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement psychologique</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement médical</label></div></div>'+
						  '</div>'+
						  
						  '<div class="bloc" id="bloc3"><h3>Public pris en charge</h3>'+
                          '<div class="pretty p-curve p-default p-pulse"><input id="ECOUTE_PSY" type="checkbox" checked>'+
                          '<div class="state p-warning"><label>Droit des étrangers</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="DROITS_SOC" type="checkbox" checked>'+
                          '<div class="state p-warning"><label>Droits sociaux</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="GENERALIST" type="checkbox" checked>'+
                          '<div class="state p-warning"><label>Violences à caractère raciste</label></div></div></div>'+
						'</div>',
						  
                classes : 'btn-group-sm',
                style   :
                {
                    margin: '10px',
                    padding: '0px 0 0 0',
                    cursor: 'pointer',
                },
                events:
                {
                    click: function(data)
                    {
						map.removeLayer(Assos);
						
						if (data.target.id == "ACCOMPAGNE"){ if (accompagne == "oui"){accompagne = "non"; $('#ACCOMPAGNE').prop('checked', false);} else if (accompagne == "non"){accompagne = "oui";$('#ACCOMPAGNE').prop('checked', true);}}
						if (data.target.id == "VIOLENCE2"){ if (violence == "oui"){violence = "non";$('#VIOLENCE2').prop('checked', false);} else if (violence == "non"){violence = "oui";$('#VIOLENCE2').prop('checked', true);}}
						if (data.target.id == "ECOUTE_PSY"){ if (psy == "oui"){psy = "non";$('#ECOUTE_PSY').prop('checked', false);} else if (psy == "non"){psy = "oui";$('#ECOUTE_PSY').prop('checked', true);}}
						if (data.target.id == "DROITS_SOC"){ if (social == "oui"){social = "non";$('#DROITS_SOC').prop('checked', false);} else if (social == "non"){social = "oui";$('#DROITS_SOC').prop('checked', true);}}
						if (data.target.id == "GENERALIST"){ if (generaliste == "oui"){generaliste = "non";$('#GENERALIST').prop('checked', false);} else if (generaliste == "non"){generaliste = "oui";$('#GENERALIST').prop('checked', true);}}
						
						AjouterAssos(accompagne, violence, psy, social, generaliste);
					}
                }
            })
            .addTo(map);
			
			/*Création de la barre de recherche par département et Région
			var geoLayers = L.layerGroup([L.geoJson(reg),L.geoJson(dep)]);
			var controlSearch = new L.Control.Search({
				position:'topright',
				layer: geoLayers,
				propertyName: 'libgeo',				
				initial: false,
				zoom: 12,
				marker: false,
				moveToLocation: function(latlng, title, map) {
					//map.fitBounds( latlng.layer.getBounds() );
					var zoom = map.getBoundsZoom(latlng.layer.getBounds());
					map.setView(latlng, zoom); // access the zoom
				}
			});
			map.addControl(controlSearch);
			map.removeLayer(geoLayers);*/
			
			
			map.addControl( new L.Control.Search({
				url: 'https://nominatim.openstreetmap.org/search/?countrycodes=fr&format=json&q={s}',
				jsonpParam: 'json_callback',
				position:'topright',
				propertyName: 'display_name',
				propertyLoc: ['lat','lon'],
				marker: false,
				zoom: 11,
				autoCollapse: false,
				autoType: false,
				minLength: 2
			}) );

			
			// Bouton "revenir à la vue par défaut"
			vueInitiale = function(LaFonctionVueInitiale) {
			var control = new (L.Control.extend({
			options: { position: 'topright' },
			onAdd: function (map) {
				controlDiv = L.DomUtil.create('div', 'hello-world-button');
				L.DomEvent
					.addListener(controlDiv, 'click', L.DomEvent.stopPropagation)
					.addListener(controlDiv, 'click', L.DomEvent.preventDefault)
					.addListener(controlDiv, 'click', this.FonctionVueInitiale);

				// Set CSS for the control border
				var controlUI = L.DomUtil.create('div', 'leaflet-container leaflet-control-search', controlDiv);
				controlUI.title = 'Revenir à la vue initiale';

				// Set CSS for the control interior
				var controlText = L.DomUtil.create('div', 'france-button', controlUI);
				controlText.innerHTML = '<div style="background: url(France_off.png) no-repeat 2px 2px #fff"> ';

				return controlDiv;
			}
			}));

			control.FonctionVueInitiale = LaFonctionVueInitiale;

			return control;
			};

			FonctionVueInitiale = function () { map.setView([48, 2.2], 6);;};
			map.addControl(vueInitiale(FonctionVueInitiale));

   </script>
	
</body>



</html>
