<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Accès Au Droit</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
	<link rel="stylesheet" href="src/leaflet-search.css" />
	<link rel="stylesheet" href="https://rawgit.com/lokesh-coder/pretty-checkbox/master/dist/pretty-checkbox.css" />
    <style>

body {
    margin: 0;
    padding: 0;
}

#mapid {
     position: absolute;
     top: 0;
     bottom: 0;
     width: 100%;
	 height: 100%;
}

.global {
	background-color:white;
}

#bloc1 {float:left; }
#bloc2 {float:left; }
#bloc3 {float:left; }

h3 {
	color: #3e505b;
	font-weight:bold;
	text-decoration: underline;
	font-size:1em;
	text-transform: uppercase;
}

.btn-group-sm {
	background-color:white;
	border-radius:7px;
	-moz-border-radius:7px;
	-webkit-border-radius:7px;
	box-shadow: 0 1px 5px rgba(0,0,0,0.65);
}

.bloc {
	padding:10px;	
	margin:0px;
	
}
	
.ol-popup {
	background-color:white;
	min-width:220px;
	max-width:350px;
	font-family: Trebuchet MS, verdana, sans serif; 
}
 .ol-popup h1,.ol-popup .h1 {
	margin:-20px;
	color:#fff;
	font-weight:bold;
	padding:15px;
	font-size:1.1em;
	border-radius:6px 6px 0 0;
	-moz-border-radius:6px 6px 0 0;
	-webkit-border-radius:6px 6px 0 0
}
.ol-popup h2 ,.ol-popup .h2{
	font-weight:bold;
	font-size:1em;
	text-decoration: underline;
}
.ol-popup p {
	margin:10px 0;
	font-size:1em;
	line-height:1em
}
.ol-popup .email:before {
	content:"";
	background: url(img/picto_couriel.png) no-repeat;
	display:inline-block;
	width:10px;
	height:10px;
	background-size:contain;
	margin-right:5px
}
.ol-popup .tel:before {
	content:"";
	background:url(img/picto_telephone.png) no-repeat;
	display:inline-block;
	width:10px;
	height:10px;
	background-size:contain;
	margin-right:5px
}

.leaflet-control-search .france-button {
	display:block;
	float:left;
	width:54px;
	height:54px;	
	background: url('img/France_off.png') no-repeat 2px 2px #fff;
	border-radius:4px;
}
.leaflet-control-search .france-button:hover {
	background: url('img/France_on.png') no-repeat 2px 2px #fafafa;
}


    </style>
</head>

<body>

	<div id="mapid" style=""></div>
	
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
	<script src="src/leaflet-search.js"></script>
	<script src="https://rawgit.com/yigityuce/Leaflet.Control.Custom/master/Leaflet.Control.Custom.js"></script>
	
	<script type="text/javascript" src="data/associations.js"></script>
	
	
    <script>
		
		// Initialisation des variables pour le filtre attributaire
		
		var SPE_ETR = "oui";
		var SPE_SOC = "oui";
		var SPE_SEX = "oui";
		var SPE_RAC = "oui";
		var SPE_LCD = "oui";		
		var acc_soc = "oui"; 
		var acc_jur = "oui"; 
		var acc_psy = "oui"; 
		var acc_med = "oui"; 
		var pub_ag = "oui";
		var pub_fe = "oui";
		var pub_tt = "oui";
		
		//var tableau = ["SPE_ETR", "SPE_SOC", "SPE_SEX", "SPE_RAC"];
		//var tableau = ['SPE_ETR', 'SPE_SOC']
		
		
		//Couleur par défaut des popup
		var title_color = "727272";
		
		//Définition et ajout des picto
		var LeafIcon = L.Icon.extend({
		options: {
			//shadowUrl: 'shadow.png',
			//shadowSize:   [23, 45],
			//shadowAnchor: [0, 0],
			iconSize:     [27, 30],
			iconAnchor:   [15, 30],
			popupAnchor:  [0, -30]
		}
		});
		
		var orangeIcon = new LeafIcon({iconUrl: 'img/PICTOS-01.png'}),
			vertIcon = new LeafIcon({iconUrl: 'img/PICTOS-02.png'}),
			violetIcon = new LeafIcon({iconUrl: 'img/PICTOS-03.png'}),
			roseFonceIcon = new LeafIcon({iconUrl: 'img/PICTOS-04.png'}),
			bleuIcon = new LeafIcon({iconUrl: 'img/PICTOS-05.png'});
			rougeIcon = new LeafIcon({iconUrl: 'img/PICTOS-06.png'});
			jauneIcon = new LeafIcon({iconUrl: 'img/PICTOS-08.png'}),
			vertFonceIcon = new LeafIcon({iconUrl: 'img/PICTOS-09.png'}),
			roseIcon = new LeafIcon({iconUrl: 'img/PICTOS-10.png'}),
			marronIcon = new LeafIcon({iconUrl: 'img/PICTOS-11.png'}),
			bleuFonceIcon = new LeafIcon({iconUrl: 'img/PICTOS-12.png'});
			bordeauxIcon = new LeafIcon({iconUrl: 'img/PICTOS-13.png'});
		
		// Attribution d'une couleur par fédération
		function colorIcon(fede) {
			if (fede === 1) return orangeIcon;
			if (fede === 2) return vertIcon;
			if (fede === 3) return violetIcon;
			if (fede === 4) return roseFonceIcon;
			if (fede === 5) return bleuIcon;
			if (fede === 6) return rougeIcon;
			if (fede === 7) return jauneIcon;
			if (fede === 8) return vertFonceIcon;
			//if (fede === 9) return roseIcon;
			//if (fede === 10) return marronIcon;
			//if (fede === "11") return bleuFonceIcon;
			//if (fede === "13") return bordeauxIcon;
			else return bleuIcon;
		}
			
		// Création de la carte
		var map = L.map('mapid')
			.setView([48, 2.2], 6);
		map.zoomControl.setPosition('topright');
		
		
		/*Ajout du fond de carte ign : TUTO https://geoservices.ign.fr/documentation/utilisation_web/wmts-leaflet.html
		L.tileLayer("https://wxs.ign.fr/ujorz7d7mcjaj467ejaqcj6l/geoportail/wmts?service=WMTS&request=GetTile&version=1.0.0&tilematrixset=PM&tilematrix={z}&tilecol={x}&tilerow={y}&layer=ORTHOIMAGERY.ORTHOPHOTOS&format=image/jpeg&style=normal",
			{
				minZoom:0,
				maxZoom:18,
				tileSize:256
			}
		).addTo(map) ;*/

		// Choix du fond de carte
		var basemap = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
		   attribution: '©OpenStreetMap, ©CartoDB, CGET service Carto',
		   subdomains: 'abcd',
		   maxZoom: 19
		   }).addTo(map);
		
		// Création des popup
		function onEachFeature(feature, layer) {
		if(feature.properties.ID_FEDE=="01"){title_color="f0900f"} else if (feature.properties.ID_FEDE=="02"){title_color="99c11f"} else if (feature.properties.ID_FEDE=="03"){title_color="9d88be"} else if (feature.properties.ID_FEDE=="04"){title_color="dd4e8a"} else if (feature.properties.ID_FEDE=="05"){title_color="2dbbeb"} else if (feature.properties.ID_FEDE=="06"){title_color="f04600"}else if (feature.properties.ID_FEDE=="07"){title_color="ffdc00"} else if (feature.properties.ID_FEDE=="08"){title_color="3ca936"}else if (feature.properties.ID_FEDE=="09"){title_color="f29fc3"} else if (feature.properties.ID_FEDE=="10"){title_color="bc8000"}else if (feature.properties.ID_FEDE=="11"){title_color="0069b2"} else if (feature.properties.ID_FEDE=="13"){title_color="881002"};
		var popupcontent = "<div id='popup' class='ol-popup'><h1 style='background-color: #"+title_color+"'>" + feature.properties.NOM_PERM + " (" +feature.properties.NOM_ASSO + ")</h1><h2></br>Coordonnées</h2><p class='email'>" + feature.properties.NOM_LIEU + ", " + feature.properties.ADRESSE + ", " + feature.properties.COMMUNE + "</p><p class='tel'>" + feature.properties.TEL_PERM + " / " + feature.properties.TEL_NAT + "</p><p>" + feature.properties.HORAIRE + "</p><p><a href=" + feature.properties.INTERNET + " style='text-decoration:none;' target='blank'>Site internet</a></p><h2 style='color: #"+title_color+"'>Spécialisé dans : </h2><p>"+feature.properties.SPE+"</p><h2 style='color: #"+title_color+"'>Accompagnement proposé au public : </h2><p>"+feature.properties.ACC+"+</p><h2 style='color: #"+title_color+"'>Public pris en charge : </h2><p>"+feature.properties.PUB+"</p><p  style='color: #727272; font-style: italic'>" + feature.properties.COM + "</p></div>";
		layer.bindPopup(popupcontent);
		}
		
		// Ajout des couches
		//var REGIONS = new L.geoJSON(reg, {"color": "#ffffff", "weight": 1, "opacity": 0, fillOpacity: 0});
		//var DEPARTEMENTS = new L.geoJSON(dep, {"color": "#ffffff", "weight": 1, "opacity": 0, fillOpacity: 0});
		var Assos = new L.geoJSON;
		
		function AjouterAssosRAC() {
		AssosRAC = L.geoJSON(Associations, {
				pointToLayer: function(feature, latlng) {
				return L.marker(latlng, {
				icon: colorIcon(feature.properties.ID_FEDE)
				});
				},
				
				filter: function (feature, layer) {
				if (feature.properties.SPE_RAC == "oui")
				return true; },
				onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		
		function AjouterAssosSEX() {
		AssosSEX = L.geoJSON(Associations, {
				pointToLayer: function(feature, latlng) {
				return L.marker(latlng, {
				icon: colorIcon(feature.properties.ID_FEDE)
				});
				},
				
				filter: function (feature, layer) {
				if (feature.properties.SPE_SEX == "oui")
				return true; },
				onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		
		function AjouterAssosETR() {
		AssosETR = L.geoJSON(Associations, {
				pointToLayer: function(feature, latlng) {
				return L.marker(latlng, {
				icon: colorIcon(feature.properties.ID_FEDE)
				});
				},
				
				filter: function (feature, layer) {
				if (feature.properties.SPE_ETR == "oui")
				return true; },
				onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		
		function AjouterAssosSOC() {
		AssosSOC = L.geoJSON(Associations, {
				pointToLayer: function(feature, latlng) {
				return L.marker(latlng, {
				icon: colorIcon(feature.properties.ID_FEDE)
				});
				},
				
				filter: function (feature, layer) {
				if (feature.properties.SPE_SOC == "oui")
				return true; },
				onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		
		function AjouterAssosLCD() {
		AssosLCD = L.geoJSON(Associations, {pointToLayer: function(feature, latlng) {return L.marker(latlng, {icon: colorIcon(feature.properties.ID_FEDE)});},
		filter: function (feature, layer) {if (feature.properties.SPE_LCD == "oui")return true; },
		onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		
		function AjouterAssosACC_SOC() {
		AssosACC_SOC = L.geoJSON(Associations, {pointToLayer: function(feature, latlng) {return L.marker(latlng, {icon: colorIcon(feature.properties.ID_FEDE)});},
		filter: function (feature, layer) {if (feature.properties.ACC_SOC == "oui")return true; },
		onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		function AjouterAssosACC_MED() {
		AssosACC_MED = L.geoJSON(Associations, {pointToLayer: function(feature, latlng) {return L.marker(latlng, {icon: colorIcon(feature.properties.ID_FEDE)});},
		filter: function (feature, layer) {if (feature.properties.ACC_MED == "oui")return true; },
		onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		function AjouterAssosACC_PSY() {
		AssosACC_PSY = L.geoJSON(Associations, {pointToLayer: function(feature, latlng) {return L.marker(latlng, {icon: colorIcon(feature.properties.ID_FEDE)});},
		filter: function (feature, layer) {if (feature.properties.ACC_PSY == "oui")return true; },
		onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		function AjouterAssosACC_JUR() {
		AssosACC_JUR = L.geoJSON(Associations, {pointToLayer: function(feature, latlng) {return L.marker(latlng, {icon: colorIcon(feature.properties.ID_FEDE)});},
		filter: function (feature, layer) {if (feature.properties.ACC_JUR == "oui")return true; },
		onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		
		function AjouterAssosPUB_AG() {
		AssosPUB_AG = L.geoJSON(Associations, {pointToLayer: function(feature, latlng) {return L.marker(latlng, {icon: colorIcon(feature.properties.ID_FEDE)});},
		filter: function (feature, layer) {if (feature.properties.PUB_AG == "oui")return true; },
		onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		function AjouterAssosPUB_FE() {
		AssosPUB_FE = L.geoJSON(Associations, {pointToLayer: function(feature, latlng) {return L.marker(latlng, {icon: colorIcon(feature.properties.ID_FEDE)});},
		filter: function (feature, layer) {if (feature.properties.PUB_FE == "oui")return true; },
		onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		function AjouterAssosPUB_TT() {
		AssosPUB_TT = L.geoJSON(Associations, {pointToLayer: function(feature, latlng) {return L.marker(latlng, {icon: colorIcon(feature.properties.ID_FEDE)});},
		filter: function (feature, layer) {if (feature.properties.PUB_TT == "oui")return true; },
		onEachFeature: onEachFeature
		}).addTo(map);	
		}	
		
		AjouterAssosRAC() ;
		AjouterAssosSEX() ;
		AjouterAssosETR() ;
		AjouterAssosSOC() ;
		AjouterAssosLCD() ;
		
		AjouterAssosACC_SOC() ;
		AjouterAssosACC_MED() ;
		AjouterAssosACC_PSY() ;
		AjouterAssosACC_JUR() ;
		
		AjouterAssosPUB_AG() ;
		AjouterAssosPUB_FE() ;
		AjouterAssosPUB_TT() ;
		
		
		
		//Ajout du filtre des associations
		L.control.custom({
                position: 'topleft',
				content : 
						'<div class="global">'+
						  '<div class="bloc" id="bloc1"><h3>Association spécialisée dans</h3>'+
                          '<div class="pretty p-curve p-default p-pulse"><input id="SPE_ETR" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Droit des étrangers</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="SPE_SOC" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Droits sociaux</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="SPE_RAC" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Violences à caractère raciste</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="SPE_SEX" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Violences à caractère sexiste</label></div></div>'+
						  
						  '</div>'+
						  
						  '<div class="bloc" id="bloc2"><h3>Accompagnement proposé au public</h3>'+
                          '<div class="pretty p-curve p-default p-pulse"><input id="ACC_SOC" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement social</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="ACC_JUR" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement juridique</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="ACC_PSY" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement psychologique</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="ACC_MED" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement médical</label></div></div>'+
						  '</div>'+
						  
						  '<div class="bloc" id="bloc3"><h3>Public pris en charge</h3>'+
                          '<div class="pretty p-curve p-default p-pulse"><input id="PUB_AG" type="checkbox" checked>'+
                          '<div class="state p-warning"><label>Personnes âgées</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="PUB_FE" type="checkbox" checked>'+
                          '<div class="state p-warning"><label>Femmes</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="PUB_TT" type="checkbox" checked>'+
                          '<div class="state p-warning"><label>Tout public</label></div></div></div>'+
						'</div>',
						  
                classes : 'btn-group-sm',
                style   :
                {
                    margin: '10px',
                    padding: '0px 0 0 0',
                    cursor: 'pointer',
                },
                events:
                {
                    click: function(data)
                    {
						//map.removeLayer(Assos);
						
						//tableau = [];
						
						if (data.target.id == "SPE_ETR"){ if (SPE_ETR == "oui"){map.removeLayer(AssosETR); SPE_ETR = "non"; $('#SPE_ETR').prop('checked', false);} else if (SPE_ETR == "non"){map.addLayer(AssosETR); SPE_ETR = "oui"; $('#SPE_ETR').prop('checked', true);}}
						if (data.target.id == "SPE_SOC"){ if (SPE_SOC == "oui"){map.removeLayer(AssosSOC);SPE_SOC = "non";$('#SPE_SOC').prop('checked', false);} else if (SPE_SOC == "non"){map.addLayer(AssosSOC); SPE_SOC = "oui";$('#SPE_SOC').prop('checked', true);}}
						if (data.target.id == "SPE_SEX"){ if (SPE_SEX == "oui"){map.removeLayer(AssosSEX);SPE_SEX = "non";$('#SPE_SEX').prop('checked', false);} else if (SPE_SEX == "non"){map.addLayer(AssosSEX); SPE_SEX = "oui";$('#SPE_SEX').prop('checked', true);}}
						if (data.target.id == "SPE_RAC"){ if (SPE_RAC == "oui"){map.removeLayer(AssosRAC);SPE_RAC = "non";$('#SPE_RAC').prop('checked', false);} else if (SPE_RAC == "non"){map.addLayer(AssosRAC); SPE_RAC = "oui";$('#SPE_RAC').prop('checked', true);}}
						if (data.target.id == "SPE_LCD"){ if (SPE_LCD == "oui"){map.removeLayer(AssosLCD);SPE_LCD = "non";$('#SPE_LCD').prop('checked', false);} else if (SPE_LCD == "non"){map.addLayer(AssosLCD); SPE_LCD = "oui";$('#SPE_LCD').prop('checked', true);}}
						
						if (data.target.id == "ACC_SOC"){ if (acc_soc == "oui"){map.removeLayer(AssosACC_SOC); acc_soc = "non";$('#ACC_SOC').prop('checked', false);} else if (acc_soc == "non"){map.addLayer(AssosACC_SOC); acc_soc = "oui";$('#ACC_SOC').prop('checked', true);}}
						if (data.target.id == "ACC_JUR"){ if (acc_jur == "oui"){map.removeLayer(AssosACC_JUR); acc_jur = "non";$('#ACC_JUR').prop('checked', false);} else if (acc_jur == "non"){map.addLayer(AssosACC_JUR); acc_jur = "oui";$('#ACC_JUR').prop('checked', true);}}
						if (data.target.id == "ACC_PSY"){ if (acc_psy == "oui"){map.removeLayer(AssosACC_PSY); acc_psy = "non";$('#ACC_PSY').prop('checked', false);} else if (acc_psy == "non"){map.addLayer(AssosACC_PSY); acc_psy = "oui";$('#ACC_PSY').prop('checked', true);}}
						if (data.target.id == "ACC_MED"){ if (acc_med == "oui"){map.removeLayer(AssosACC_MED); acc_med = "non";$('#ACC_MED').prop('checked', false);} else if (acc_med == "non"){map.addLayer(AssosACC_MED); acc_med = "oui";$('#ACC_MED').prop('checked', true);}}
						
						if (data.target.id == "PUB_AG"){ if (pub_ag == "oui"){map.removeLayer(AssosPUB_AG); pub_ag = "non";$('#PUB_AG').prop('checked', false);} else if (pub_ag == "non"){map.addLayer(AssosPUB_AG); pub_ag = "oui";$('#PUB_AG').prop('checked', true);}}
						if (data.target.id == "PUB_FE"){ if (pub_fe == "oui"){map.removeLayer(AssosPUB_FE); pub_fe = "non";$('#PUB_FE').prop('checked', false);} else if (pub_fe == "non"){map.addLayer(AssosPUB_FE); pub_fe = "oui";$('#PUB_FE').prop('checked', true);}}
						if (data.target.id == "PUB_TT"){ if (pub_tt == "oui"){map.removeLayer(AssosPUB_TT); pub_tt = "non";$('#PUB_TT').prop('checked', false);} else if (pub_tt == "non"){map.addLayer(AssosPUB_TT); pub_tt = "oui";$('#PUB_TT').prop('checked', true);}}
						
					}
                }
            })
            .addTo(map);
			
			/*Création de la barre de recherche par département et Région
			var geoLayers = L.layerGroup([L.geoJson(reg),L.geoJson(dep)]);
			var controlSearch = new L.Control.Search({
				position:'topright',
				layer: geoLayers,
				propertyName: 'libgeo',				
				initial: false,
				zoom: 12,
				marker: false,
				moveToLocation: function(latlng, title, map) {
					//map.fitBounds( latlng.layer.getBounds() );
					var zoom = map.getBoundsZoom(latlng.layer.getBounds());
					map.setView(latlng, zoom); // access the zoom
				}
			});
			map.addControl(controlSearch);
			map.removeLayer(geoLayers);*/
			
			
			map.addControl( new L.Control.Search({
				url: 'https://nominatim.openstreetmap.org/search/?countrycodes=fr&format=json&q={s}',
				jsonpParam: 'json_callback',
				position:'topright',
				propertyName: 'display_name',
				propertyLoc: ['lat','lon'],
				marker: false,
				zoom: 11,
				autoCollapse: false,
				autoType: false,
				minLength: 2
			}) );

			
			// Bouton "revenir à la vue par défaut"
			vueInitiale = function(LaFonctionVueInitiale) {
			var control = new (L.Control.extend({
			options: { position: 'topright' },
			onAdd: function (map) {
				controlDiv = L.DomUtil.create('div', 'hello-world-button');
				L.DomEvent
					.addListener(controlDiv, 'click', L.DomEvent.stopPropagation)
					.addListener(controlDiv, 'click', L.DomEvent.preventDefault)
					.addListener(controlDiv, 'click', this.FonctionVueInitiale);

				// Set CSS for the control border
				var controlUI = L.DomUtil.create('div', 'leaflet-container leaflet-control-search', controlDiv);
				controlUI.title = 'Revenir à la vue initiale';

				// Set CSS for the control interior
				var controlText = L.DomUtil.create('div', 'france-button', controlUI);
				controlText.innerHTML = '<div style="background: url(img/France_off.png) no-repeat 2px 2px #fff"> ';

				return controlDiv;
			}
			}));

			control.FonctionVueInitiale = LaFonctionVueInitiale;

			return control;
			};

			FonctionVueInitiale = function () { map.setView([48, 2.2], 6);;};
			map.addControl(vueInitiale(FonctionVueInitiale));

   </script>
	
</body>



</html>
