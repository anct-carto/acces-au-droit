<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>A simple map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
	<link rel="stylesheet" href="http://labs.easyblog.it/maps/leaflet-search/src/leaflet-search.css" />
	<link rel="stylesheet" href="pretty-checkbox.min.css" />
    <style>

body {
    margin: 0;
    padding: 0;
}

#map {
     position: absolute;
     top: 0;
     bottom: 0;
     width: 100%;
}

.global {
width:100%;
background-color:white; }

#bloc1 {float:left; }
#bloc2 {float:left; }
#bloc3 {float:left; }

h3 {
	color: #3e505b;
	font-weight:bold;
	text-decoration: underline;
	font-size:1em;
	text-transform: uppercase;
}

.btn-group-sm {
	background-color:white;
	border-radius:7px;
	-moz-border-radius:7px;
	-webkit-border-radius:7px;
	box-shadow: 0 1px 5px rgba(0,0,0,0.65);
}

.bloc {
	padding:10px;	
	margin:0px;
	
}
	
.ol-popup {
	background-color:white;
	min-width:220px;
	max-width:350px;
	font-family: Trebuchet MS, verdana, sans serif; 
}
 .ol-popup h1,.ol-popup .h1 {
	margin:-20px;
	color:#fff;
	font-weight:bold;
	padding:15px;
	font-size:1.1em;
	border-radius:6px 6px 0 0;
	-moz-border-radius:6px 6px 0 0;
	-webkit-border-radius:6px 6px 0 0
}
.ol-popup h2 ,.ol-popup .h2{
	font-weight:bold;
	font-size:1em;
	text-decoration: underline;
}
.ol-popup p {
	margin:10px 0;
	font-size:1em;
	line-height:1em
}
.ol-popup .email:before {
	content:"";
	background: url(picto_couriel.png) no-repeat;
	display:inline-block;
	width:10px;
	height:10px;
	background-size:contain;
	margin-right:5px
}
.ol-popup .tel:before {
	content:"";
	background:url(picto_telephone.png) no-repeat;
	display:inline-block;
	width:10px;
	height:10px;
	background-size:contain;
	margin-right:5px
}


#findbox {
	background: #eee;
	border-radius:.125em;
	border:2px solid #1978cf;
	box-shadow: 0 0 8px #999;	
	margin-bottom: 10px;
	padding: 2px 0;
	width: 600px;
	height: 26px;
}
.search-tooltip {
	width: 200px;
}
.leaflet-control-search .search-cancel {
	position: static;
	float: left;
	margin-left: -22px;
}


    </style>
</head>

<body>

	<div id="mapid" style="width: 825px; height: 800px;"></div>
	<div id="findbox"></div>
	
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
	<script src="http://labs.easyblog.it/maps/leaflet-search/dist/leaflet-search.src.js"></script>
	<script src="Leaflet.Control.Custom.js"></script>
	<script type="text/javascript" src="regions.js"></script>
	<script type="text/javascript" src="associations.js"></script>
	<script type="text/javascript" src="Fr_Departement_GEN.js"></script>
	
    <script>
		
		var accompagne = "oui"; 
		var violence = "oui"; 
		var psy = "oui";
		var social = "oui";
		var generaliste = "oui";
		
		var title_color = "727272";
		
		//Définition et ajout des picto
		var LeafIcon = L.Icon.extend({
		options: {
			//shadowUrl: 'shadow.png',
			//shadowSize:   [23, 45],
			//shadowAnchor: [0, 0],
			iconSize:     [27, 30],
			iconAnchor:   [0, 0],
			popupAnchor:  [13, 0]
		}
		});
		
		var orangeIcon = new LeafIcon({iconUrl: 'PICTOS-01.png'}),
			vertIcon = new LeafIcon({iconUrl: 'PICTOS-02.png'}),
			violetIcon = new LeafIcon({iconUrl: 'PICTOS-03.png'}),
			roseIcon = new LeafIcon({iconUrl: 'PICTOS-04.png'}),
			bleuIcon = new LeafIcon({iconUrl: 'PICTOS-05.png'});
			rougeIcon = new LeafIcon({iconUrl: 'PICTOS-06.png'});
		
		function colorIcon(fede) {
			if (fede === "01") return orangeIcon;
			if (fede === "02") return vertIcon;
			if (fede === "03") return violetIcon;
			if (fede === "04") return roseIcon;
			if (fede === "05") return bleuIcon;
			if (fede === "06") return rougeIcon;
			if (fede === "07") return orangeIcon;
			if (fede === "08") return orangeIcon;
			if (fede === "09") return orangeIcon;
			else return bleuIcon;
		}
			
	//Création de la carte
    var map = L.map('mapid')
        .setView([48, 2.2], 6);
		
	map.zoomControl.setPosition('topright');

    var basemap = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
       attribution: '©OpenStreetMap, ©CartoDB, CGET service Carto',
       subdomains: 'abcd',
       maxZoom: 19
       }).addTo(map);
			
	/*Fond de carte labels
	map.createPane('labels');
	map.getPane('labels').style.zIndex = 650;
	map.getPane('labels').style.pointerEvents = 'none';
	var basemap_labels = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
	attribution: ' ',
	pane: 'labels'
	}).addTo(map);	*/
    
		//specify popup options 
		var customOptions =
        {
        //'maxWidth': '50',
        }
		
		function onEachFeature(feature, layer) {
		if(feature.properties.ID_FEDE=="01"){title_color="F0900F"} else if (feature.properties.ID_FEDE=="02"){title_color="99C11F"} else if (feature.properties.ID_FEDE=="03"){title_color="9D88BE"} else if (feature.properties.ID_FEDE=="04"){title_color="DD4E8A"} else if (feature.properties.ID_FEDE=="05"){title_color="2DBBEB"} else if (feature.properties.ID_FEDE=="06"){title_color="F04600"};
		var popupcontent = "<div id='popup' class='ol-popup'><h1 style='background-color: #"+title_color+"'>" + feature.properties.NOM_PERM + " (" +feature.properties.NOM_ASSO + ")</h1><h2></br>Coordonnées</h2><p class='email'>" + feature.properties.NOM_LIEU + ", " + feature.properties.ADRESSE + ", " + feature.properties.COMMUNE + "</p><p class='tel'>" + feature.properties.TEL_PERM + " / " + feature.properties.TEL_NAT + "</p><p>" + feature.properties.HORAIRE + "</p><p>" + feature.properties.INTERNET + "</p><h2 style='color: #"+title_color+"'>Spécialisé dans : </h2><p>Droit des étrangers, droits sociaux, violences à caractère raciste, violences à caractère sexiste, lutte contres les discriminations</p><h2 style='color: #"+title_color+"'>Accompagnement proposé au public : </h2><p>Accompagnement social, juridique, psychologique, médical</p><h2 style='color: #"+title_color+"'>Public pris en charge : </h2><p>Spécifique personnes âgées, femme / tout public</p><p  style='color: #727272; font-style: italic'>" + feature.properties.COM + "</p></div>";
		layer.bindPopup(popupcontent,customOptions);
		}
		
		var REGIONS = new L.geoJSON(reg, {"color": "#ffffff", "weight": 1, "opacity": 0, fillOpacity: 0});
		var Assos = new L.geoJSON;
		
		function AjouterAssos(accompagne, violence, psy, social, generaliste) {
		Assos = L.geoJSON(Associations, {
				pointToLayer: function(feature, latlng) {
				return L.marker(latlng, {
				icon: colorIcon(feature.properties.ID_FEDE)
				});
				},
				filter: function (feature) {
				return (feature.properties.ACCOMPAGNE == accompagne && feature.properties.VIOLENCES2 == violence && feature.properties.ECOUTE_PSY == psy && feature.properties.DROITS_SOC == social && feature.properties.GENERALIST == generaliste) ;
				},
				onEachFeature: onEachFeature
		}).addTo(map);	
		;
		}	
		
		AjouterAssos(accompagne, violence, psy, social, generaliste) ;
		
		
		
		//Ajout du filtre des associations
		L.control.custom({
                position: 'topleft',
				content : 
						'<div class="global">'+
						  '<div class="bloc" id="bloc1"><h3>L\'association est spécialisée dans</h3>'+
                          '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Droit des étrangers</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Droits sociaux</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="ACCOMPAGNE" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Violences à caractère raciste</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-primary"><label>Violences à caractère sexiste</label></div></div>'+
						  '</div>'+
						  
						  '<div class="bloc" id="bloc2"><h3>Accompagnement proposé au public</h3>'+
                          '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement social</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement juridique</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="ACCOMPAGNE" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement psychologique</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="VIOLENCE2" type="checkbox" checked>'+
                          '<div class="state p-success"><label>Accompagnement médical</label></div></div>'+
						  '</div>'+
						  
						  '<div class="bloc" id="bloc3"><h3>Public pris en charge</h3>'+
                          '<div class="pretty p-curve p-default p-pulse"><input id="ECOUTE_PSY" type="checkbox" checked>'+
                          '<div class="state p-warning"><label>Droit des étrangers</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="DROITS_SOC" type="checkbox" checked>'+
                          '<div class="state p-warning"><label>Droits sociaux</label></div></div></br>'+
						  '<div class="pretty p-curve p-default p-pulse"><input id="GENERALIST" type="checkbox" checked>'+
                          '<div class="state p-warning"><label>Violences à caractère raciste</label></div></div></div>'+
						'</div>',
						  
                classes : 'btn-group-sm',
                style   :
                {
                    margin: '10px',
                    padding: '0px 0 0 0',
                    cursor: 'pointer',
                },
                datas   :
                {
                    //'foo': Assos,
					//'regions': Regions,
                },
                events:
                {
                    click: function(data)
                    {
						map.removeLayer(Assos);
						
						if (data.target.id == "ACCOMPAGNE"){ if (accompagne == "oui"){accompagne = "non"; $('#ACCOMPAGNE').prop('checked', false);} else if (accompagne == "non"){accompagne = "oui";$('#ACCOMPAGNE').prop('checked', true);}}
						if (data.target.id == "VIOLENCE2"){ if (violence == "oui"){violence = "non";$('#VIOLENCE2').prop('checked', false);} else if (violence == "non"){violence = "oui";$('#VIOLENCE2').prop('checked', true);}}
						if (data.target.id == "ECOUTE_PSY"){ if (psy == "oui"){psy = "non";$('#ECOUTE_PSY').prop('checked', false);} else if (psy == "non"){psy = "oui";$('#ECOUTE_PSY').prop('checked', true);}}
						if (data.target.id == "DROITS_SOC"){ if (social == "oui"){social = "non";$('#DROITS_SOC').prop('checked', false);} else if (social == "non"){social = "oui";$('#DROITS_SOC').prop('checked', true);}}
						if (data.target.id == "GENERALIST"){ if (generaliste == "oui"){generaliste = "non";$('#GENERALIST').prop('checked', false);} else if (generaliste == "non"){generaliste = "oui";$('#GENERALIST').prop('checked', true);}}
						
						AjouterAssos(accompagne, violence, psy, social, generaliste);
					}
                }
            })
            .addTo(map);
   

			
			var controlSearch = new L.Control.Search({
				position:'topright',
				layer: REGIONS,
				propertyName: 'Nom_Reg',				
				initial: false,
				zoom: 12,
				marker: false,
				moveToLocation: function(latlng, title, map) {
					//map.fitBounds( latlng.layer.getBounds() );
					var zoom = map.getBoundsZoom(latlng.layer.getBounds());
					map.setView(latlng, zoom); // access the zoom
				}
			});
			map.addControl(controlSearch);
			

   </script>
	
</body>



</html>
